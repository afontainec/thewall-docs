<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Building our first RESTful API | Chinchay Docs</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.ab30e0ca.css" as="style"><link rel="preload" href="/assets/js/app.2773cf3e.js" as="script"><link rel="preload" href="/assets/js/2.3f720234.js" as="script"><link rel="preload" href="/assets/js/22.ca5d3982.js" as="script"><link rel="prefetch" href="/assets/js/10.1edc54dd.js"><link rel="prefetch" href="/assets/js/11.2f00b1d8.js"><link rel="prefetch" href="/assets/js/12.1f05b6b4.js"><link rel="prefetch" href="/assets/js/13.c98ba095.js"><link rel="prefetch" href="/assets/js/14.1b2b2c75.js"><link rel="prefetch" href="/assets/js/15.702d946e.js"><link rel="prefetch" href="/assets/js/16.a41c1694.js"><link rel="prefetch" href="/assets/js/17.335d4649.js"><link rel="prefetch" href="/assets/js/18.23ce0973.js"><link rel="prefetch" href="/assets/js/19.aa8171a6.js"><link rel="prefetch" href="/assets/js/20.fcee7802.js"><link rel="prefetch" href="/assets/js/21.84451ad4.js"><link rel="prefetch" href="/assets/js/23.d5279137.js"><link rel="prefetch" href="/assets/js/24.41953457.js"><link rel="prefetch" href="/assets/js/25.6f8b54bd.js"><link rel="prefetch" href="/assets/js/26.9965863d.js"><link rel="prefetch" href="/assets/js/27.5c297913.js"><link rel="prefetch" href="/assets/js/28.cc8160a1.js"><link rel="prefetch" href="/assets/js/29.3a7bb5f9.js"><link rel="prefetch" href="/assets/js/3.6a2b7fa3.js"><link rel="prefetch" href="/assets/js/30.42d9cb16.js"><link rel="prefetch" href="/assets/js/31.071fae85.js"><link rel="prefetch" href="/assets/js/32.9325ffa2.js"><link rel="prefetch" href="/assets/js/33.4af5988e.js"><link rel="prefetch" href="/assets/js/34.c865156d.js"><link rel="prefetch" href="/assets/js/35.d3ce8ef4.js"><link rel="prefetch" href="/assets/js/36.11f74532.js"><link rel="prefetch" href="/assets/js/4.1b09c2c5.js"><link rel="prefetch" href="/assets/js/5.5c4c1fbb.js"><link rel="prefetch" href="/assets/js/6.b0461825.js"><link rel="prefetch" href="/assets/js/7.3211b211.js"><link rel="prefetch" href="/assets/js/8.a7dcf5bf.js"><link rel="prefetch" href="/assets/js/9.0aa8bee1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ab30e0ca.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Chinchay Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/gettingstarted/" class="nav-link router-link-active">
  Getting Started
</a></div><div class="nav-item"><a href="/docs/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/models/" class="nav-link">
  The Model
</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">
  Middleware
</a></div><div class="nav-item"><a href="/errorhandler/" class="nav-link">
  Error Handler
</a></div><div class="nav-item"><a href="/collaborate/" class="nav-link">
  Collaborate!
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/gettingstarted/" class="nav-link router-link-active">
  Getting Started
</a></div><div class="nav-item"><a href="/docs/" class="nav-link">
  Docs
</a></div><div class="nav-item"><a href="/models/" class="nav-link">
  The Model
</a></div><div class="nav-item"><a href="/middleware/" class="nav-link">
  Middleware
</a></div><div class="nav-item"><a href="/errorhandler/" class="nav-link">
  Error Handler
</a></div><div class="nav-item"><a href="/collaborate/" class="nav-link">
  Collaborate!
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/gettingstarted/ejs.html" class="sidebar-link">Getting Started</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/gettingstarted/ejs.html#getting-started-with-chinchay-ejs" class="sidebar-link">Getting Started with Chinchay + ejs</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/ejs.html#create-nodejs-app-with-express" class="sidebar-link">Create nodejs app with express</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/ejs.html#create-postgresql-database" class="sidebar-link">Create Postgresql Database</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/ejs.html#connecting-to-the-database" class="sidebar-link">Connecting to the Database</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/ejs.html#using-chinchay" class="sidebar-link">Using Chinchay</a></li></ul></li><li><a href="/gettingstarted/angular.html" class="sidebar-link">Getting Started: Chinchay + Angular</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/gettingstarted/angular.html#getting-started-with-chinchay-angular" class="sidebar-link">Getting Started with Chinchay + Angular</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/angular.html#backend-server" class="sidebar-link">Backend Server</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/angular.html#angular-app" class="sidebar-link">Angular App</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/angular.html#chinchay" class="sidebar-link">Chinchay</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/angular.html#connecting-backend-and-frontend" class="sidebar-link">Connecting Backend and Frontend</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/angular.html#running-the-app" class="sidebar-link">Running the app</a></li></ul></li><li><a href="/gettingstarted/apiMiddleware.html" aria-current="page" class="active sidebar-link">Getting Started: RESTful API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/gettingstarted/apiMiddleware.html#building-our-first-restful-api" class="sidebar-link">Building our first RESTful API</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/apiMiddleware.html#create-nodejs-app-with-express" class="sidebar-link">Create nodejs app with express</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/apiMiddleware.html#creating-the-coffee-tea-relations" class="sidebar-link">Creating the coffee + tea relations</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/apiMiddleware.html#creating-the-users" class="sidebar-link">Creating the users</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/apiMiddleware.html#getting-the-token" class="sidebar-link">Getting the token</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/apiMiddleware.html#configuring-thewall" class="sidebar-link">Configuring TheWall</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/apiMiddleware.html#configuring-access" class="sidebar-link">Configuring Access</a></li><li class="sidebar-sub-header"><a href="/gettingstarted/apiMiddleware.html#conclusion" class="sidebar-link">Conclusion</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="building-our-first-restful-api"><a href="#building-our-first-restful-api" class="header-anchor">#</a> Building our first RESTful API</h2> <p>This tutorial will walk you through building your first API with Chinchay! It will not only be a RESTful API but we will also configure our middleware and access to filter which user can access which resources.</p> <h3 id="defining-concepts"><a href="#defining-concepts" class="header-anchor">#</a> Defining concepts</h3> <ul><li><p><a href="https://oauth.net/2/" target="_blank" rel="noopener noreferrer">oAuth 2.0<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>: oAuth is an industry-standard protocol for authorization. In simple terms, you can protect so each user only access the endpoint you give him access to. The user authenticates given it's credentials and is granted an access token. For every request he does after he must provide the token to prove his identity.</p></li> <li><p><a href="./middleware">The Chinchay Middleware</a> will be in charge of inspecting that the token is present, valid and that the user of that token has access to the given endpoint. The token is expected to be given as a <a href="https://stackoverflow.com/questions/25838183/what-is-the-oauth-2-0-bearer-token-exactly/25843058" target="_blank" rel="noopener noreferrer">Bearer Token<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></li> <li><p><a href="https://www.npmjs.com/package/thewall" target="_blank" rel="noopener noreferrer">TheWall npm package<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. To actually define which user has access to which endpoints.</p></li> <li><p>The <a href="./middleware#access">Access Module</a> will be in charge of generating the access token, the token follows the <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">json web token standard<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, by generating the token with <a href="https://www.npmjs.com/package/jsonwebtoken" target="_blank" rel="noopener noreferrer">the jsonwebtoken npm package<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Also will be in charge of filtering who has access to which data within a given endpoint.</p></li></ul> <h3 id="quick-overview"><a href="#quick-overview" class="header-anchor">#</a> Quick Overview</h3> <p>So we are going to create an API with information about coffees and teas. Some users will only be allowed to read information about specific coffees, others only about specific teas, whereas others will be granted full access. So let's dive into how to configure this!</p> <h3 id="requirements"><a href="#requirements" class="header-anchor">#</a> Requirements</h3> <ul><li><a href="https://www.npmjs.com/get-npm" target="_blank" rel="noopener noreferrer">npm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://expressjs.com/" target="_blank" rel="noopener noreferrer">express<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.postgresql.org/" target="_blank" rel="noopener noreferrer">Postgres<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>If you do not have express installed you can easily install it with npm</p> <div class="language- extra-class"><pre class="language-text"><code>$ npm install express -g
</code></pre></div><h2 id="create-nodejs-app-with-express"><a href="#create-nodejs-app-with-express" class="header-anchor">#</a> Create nodejs app with express</h2> <p>Create a nodejs app called: tutorial-chinchay-api</p> <div class="language- extra-class"><pre class="language-text"><code>$ express tutorial-chinchay-api 
$ cd tutorial-chinchay-api
</code></pre></div><br>
We will install drivers to use PostgresSQL database. we will use knex.js and pg
<div class="language- extra-class"><pre class="language-text"><code>$ npm install pg -s
$ npm install knex -s
</code></pre></div><br>
Also we will use ejs instead of jade. So we need to run
<p>Let's run the app to see what we have so far!</p> <div class="language- extra-class"><pre class="language-text"><code>$ npm install
$ npm start
</code></pre></div><br> <p>You can visit <a href="http://localhost:3000" target="_blank" rel="noopener noreferrer">http://localhost:3000<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to see the default express web app... but we are here for the API so let's move on!</p> <h3 id="create-postgresql-database"><a href="#create-postgresql-database" class="header-anchor">#</a> Create Postgresql Database</h3> <p>In this tutorial we will not dig in how Postgres fully work. For more information on how to work around Postgres visit <a href="https://www.postgresql.org/" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>In order to connect to Postgres, we need to create a database. If you have postgresql installed you can run</p> <div class="language- extra-class"><pre class="language-text"><code>$ psql
</code></pre></div><br>
This should open up the postgresql console. Run the following command:
<div class="language- extra-class"><pre class="language-text"><code>postgres=# CREATE DATABASE tutorial_chinchay_api;
</code></pre></div><p><em>NOTE:</em> Depending on your default user and psql version the syntax of the previous line may vary.</p> <p>if it's successful close psql, run:</p> <div class="language- extra-class"><pre class="language-text"><code>postgres=# \q
</code></pre></div><h3 id="connecting-to-the-database"><a href="#connecting-to-the-database" class="header-anchor">#</a> Connecting to the Database</h3> <p>For connecting our app to the database chinchay uses <a href="https://knex.org/" target="_blank" rel="noopener noreferrer">knex<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. In this tutorial we will not dig in how knex fully works. For more information on how to work around knex <a href="https://knex.org/" target="_blank" rel="noopener noreferrer">click here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>First of all, we highly recommend to install knex globally:</p> <div class="language- extra-class"><pre class="language-text"><code>$ npm install knex -g
</code></pre></div><br>
Until now we should have the following Directory Structure:
<div class="language- extra-class"><pre><code>.
├── bin                  
├── node_modules       
├── public   
├── routes
├── views              
├── app.js
├── package-lock.json
└── package.json
</code></pre></div><p>We will add the following:</p> <div class="language- extra-class"><pre><code>.
├── bin
├── database
    ├── migrations       
    └── seeds
        ├── development
        ├── production   
        └──  test
├── node_modules       
├── public   
├── routes
├── views              
├── app.js
├── knexfile.js        
├── knex.js        
├── package-lock.json
└── package.json
</code></pre></div><br> <ul><li>database/migrations/ directory will hold all the migrations (changes) to the database.</li> <li>database/seed/ directory will hold all the seed files. Every subdirectory will hold the seed corresponding to that environment.</li> <li>knex.js Will be the instance that connects to the database and the knexfile.js will hold the configurations.
<br>
Go ahead and create those files</li></ul> <p>Before we continue we need to create a configuration file to let knex know how to interact with the database. We need to create a knexfile.js</p> <div class="language- extra-class"><pre class="language-text"><code>$ touch knexfile.js
</code></pre></div><br>
Add the following code to knexfile.js
<div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> <span class="token string">'pg'</span><span class="token punctuation">,</span>
    connection<span class="token operator">:</span> <span class="token string">'postgres://localhost:5432/test_chinchay'</span><span class="token punctuation">,</span>
    migrations<span class="token operator">:</span> <span class="token punctuation">{</span>
      directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/database/migrations'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    seeds<span class="token operator">:</span> <span class="token punctuation">{</span>
      directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/database/seeds/test'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    acquireConnectionTimeout<span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  development<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> <span class="token string">'pg'</span><span class="token punctuation">,</span>
    connection<span class="token operator">:</span> <span class="token string">'postgres://localhost:5432/tutorial_chinchay_api'</span><span class="token punctuation">,</span>
    migrations<span class="token operator">:</span> <span class="token punctuation">{</span>
      directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/database/migrations'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    seeds<span class="token operator">:</span> <span class="token punctuation">{</span>
      directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/database/seeds/development'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    acquireConnectionTimeout<span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  production<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> <span class="token string">'pg'</span><span class="token punctuation">,</span>
    connection<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span> <span class="token operator">||</span> <span class="token string">'postgres://localhost:5432/tutorial_chinchay_api'</span><span class="token punctuation">,</span>
    migrations<span class="token operator">:</span> <span class="token punctuation">{</span>
      directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/database/migrations'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    seeds<span class="token operator">:</span> <span class="token punctuation">{</span>
      directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/database/seeds/production'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    acquireConnectionTimeout<span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  staging<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> <span class="token string">'pg'</span><span class="token punctuation">,</span>
    connection<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span> <span class="token operator">||</span> <span class="token string">'postgres://localhost:5432/tutorial_chinchay_api'</span><span class="token punctuation">,</span>
    migrations<span class="token operator">:</span> <span class="token punctuation">{</span>
      directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/database/migrations'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    seeds<span class="token operator">:</span> <span class="token punctuation">{</span>
      directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/database/seeds/production'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    acquireConnectionTimeout<span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>If your Postgres user it is not postgres change it accordingly in the connection URL.</p></div> <p>We will not get in detail of how this file works, but basically we are telling knex where we want to save the migrations, the seeds and what is the url to connect to the database. Note that the knexfile defines this variables for every environment by separate.</p> <p>Now we need to add the following code to the knex.js file:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> environment <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./knexfile'</span><span class="token punctuation">)</span><span class="token punctuation">[</span>environment<span class="token punctuation">]</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'knex'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now knex is configured to connect to the database.</p> <h2 id="creating-the-coffee-tea-relations"><a href="#creating-the-coffee-tea-relations" class="header-anchor">#</a> Creating the coffee + tea relations</h2> <p>Now let's get to the fun part: Chinchay. We will create the .chainfile.js, this file holds all of the configurations for chinchay.</p> <p>Go ahead and create this file.</p> <p>In the .chainfile.js add the following:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  models<span class="token operator">:</span> <span class="token punctuation">{</span>
    directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'models'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">{</span>
    directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'controllers'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  views<span class="token operator">:</span> <span class="token punctuation">{</span>
    directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  routes<span class="token operator">:</span> <span class="token punctuation">{</span>
    directory<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'routes'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  knex<span class="token operator">:</span>  path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'knex.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Here we are defining which directories will hold the models, the controllers, the views and the routes.</p> <p>Install chinchay:</p> <div class="language- extra-class"><pre class="language-text"><code>$ npm install chinchay -s
$ npm install chinchay -g
</code></pre></div><br>
Installing chinchay globally will allow you to run chinchay CLI.
<h3 id="coffee-and-tea"><a href="#coffee-and-tea" class="header-anchor">#</a> Coffee And Tea</h3> <p>Now it's time to create the coffees and the teas!</p> <div class="language- extra-class"><pre class="language-text"><code>$ chinchay new coffee --middleware api --frontend disable
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>$ chinchay new tea --middleware api --frontend disable
</code></pre></div><p>These will create models, controllers, views, routes and knex migrations in the directories defined in .chainfile.js. We shall use this to work with both coffees and teas.</p> <p>The migrations will be saved in the directory <code>database/migrations/</code>. The name will vary, as it takes the current date and time to make the file, The file that has <code>coffee.js</code> appended add the following:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">up</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'coffee'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">table</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Incremental id</span>
    table<span class="token punctuation">.</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table<span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token string">'price'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// created_at and updated_at</span>
    table<span class="token punctuation">.</span><span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">down</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'coffee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>This piece of code will create a relation called coffee within our database with the variables name and price. Also will generate an id and a created_at and updated_at timestamps for every entry. To run this migration:</p> <p>We will do the sale with the file that ends in <code>tea.js</code>:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">up</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'tea'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">table</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Incremental id</span>
    table<span class="token punctuation">.</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table<span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token string">'price'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// created_at and updated_at</span>
    table<span class="token punctuation">.</span><span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">down</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'tea'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we can run these migrations:</p> <div class="language- extra-class"><pre class="language-text"><code>$ knex migrate:latest
</code></pre></div><br> <p>Last but not least, in the app.js file, replace these lines:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> routes<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> users<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>with these :</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Middleware<span class="token punctuation">.</span><span class="token function">prerouting</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> routes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> teaAPI <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/teaAPI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> coffeeAPI <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/coffeeAPI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> teaAPI<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> coffeeAPI<span class="token punctuation">)</span><span class="token punctuation">;</span>

Middleware<span class="token punctuation">.</span><span class="token function">postrouting</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>These lines tell the app to use the generated API. Note that we must require the <code>Middleware</code> at the beginning of the <code>app.js</code> file:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Middleware <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chinchay'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now if we ran the app:</p> <div class="language- extra-class"><pre class="language-text"><code>$ npm start
</code></pre></div><p>We will get an error! Why? We have not configured the middleware yet!</p> <h3 id="temporaring-middleware-configuration"><a href="#temporaring-middleware-configuration" class="header-anchor">#</a> Temporaring Middleware Configuration</h3> <p>On the <a href="#configuring-the-middleware">Configure the Middleware</a> part we will dig on how to fully configure the middleware, for now let's add the following:</p> <h4 id="access-js"><a href="#access-js" class="header-anchor">#</a> access.js</h4> <p>Create an <code>access.js</code> file</p> <div class="language- extra-class"><pre class="language-text"><code>$ touch access.js
</code></pre></div><p>and add the following:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token constant">UNRESTRICTED_ROLES</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">RESTRICTED_ROLES</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">UNRESTRICTED_ROLES</span><span class="token punctuation">,</span>
  <span class="token constant">RESTRICTED_ROLES</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="thewall-js"><a href="#thewall-js" class="header-anchor">#</a> thewall.js</h4> <p>We need to add TheWall to the project:</p> <div class="language- extra-class"><pre class="language-text"><code>$ npm i thewall -s
</code></pre></div><p>Let's create a thewallfile that will hold all the configurations:</p> <div class="language- extra-class"><pre class="language-text"><code>$ touch thewallfile.js
</code></pre></div><p>Fill the generate fill with:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  access<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  knex<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'knex.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Now create a <code>thewall</code> instance:</p> <div class="language- extra-class"><pre class="language-text"><code>$ touch thewall.js
</code></pre></div><p>Fill the generate fill with:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./thewallfile'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'thewall'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h4 id="chainfile-js"><a href="#chainfile-js" class="header-anchor">#</a> chainfile.js</h4> <p>Last but not least add the following to the chainfile:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  access<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'access.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  thewall<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'thewall.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre></div><p>Right after the line:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  knex<span class="token operator">:</span>  path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'knex.js'</span><span class="token punctuation">)</span>
</code></pre></div><p>Its time to rerun our app:</p> <div class="language- extra-class"><pre class="language-text"><code>$ npm start
</code></pre></div><p>Visit an API endpoint, for instance: <a href="http://localhost:3000/api/coffee/find" target="_blank" rel="noopener noreferrer">localhost:3000/api/coffee/find<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>We will receive a 403 Forbidden error. This is because we added the <code>--middleware</code> flag and did not provide a valid authentication. Let's create users and start requesting with a valid authentication!</p> <h2 id="creating-the-users"><a href="#creating-the-users" class="header-anchor">#</a> Creating the users</h2> <p>Let's create our users:</p> <div class="language- extra-class"><pre class="language-text"><code>$ chinchay new users --middleware api --frontend disable
</code></pre></div><p>Replace the generated migration with the following:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">up</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">table</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Incremental id</span>
    table<span class="token punctuation">.</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    table<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// created_at and updated_at</span>
    table<span class="token punctuation">.</span><span class="token function">timestamps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">down</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">knex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Run the migration:</p> <div class="language- extra-class"><pre class="language-text"><code>$ knex migrate:latest
</code></pre></div><p>On the generated model, we will add the following:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Table<span class="token punctuation">,</span> ChinchayError <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chinchay'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcrypt-nodejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">class</span> <span class="token class-name">Users</span> <span class="token keyword">extends</span> <span class="token class-name">Table</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tableName <span class="token operator">=</span> <span class="token string">'users'</span><span class="token punctuation">;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">save</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    user<span class="token punctuation">.</span>password <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> bcrypt<span class="token punctuation">.</span><span class="token function">genSaltSync</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// encrypt password</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">checkCredentials</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">getUserByCredentials</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkCredentials</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChinchayError</span><span class="token punctuation">(</span><span class="token string">'username password do not match'</span><span class="token punctuation">,</span> <span class="token string">'wrong_credentials'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> instance<span class="token punctuation">;</span>

</code></pre></div><div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>Passwords must <strong>NEVER</strong> be saved as plain text in the database and always should be encrypted.</p></div> <p>We added three methods. One that overwrites the <code>save</code> method by encrypting the password before saving the user. For it to work we must add the following package to encrypt:</p> <div class="language- extra-class"><pre class="language-text"><code>  $ npm i bcrypt-nodejs -s
</code></pre></div><p>The second method is to check that some given credentials are correct. And the third, will return the user with the given username/password. If there is no user with that combination it will reject with an error. Why do we throw a ChinchayError and not a regular Error? This will allow the controller to send the correct code and message, we will talk more about this in the <a href="#returning-a-401-code">Returning a 401 Code</a> section.</p> <p>For adding the users routes, on the <code>app.js</code> add the following right after the <code>Middleware.prerouting(app)</code>:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Middleware<span class="token punctuation">.</span><span class="token function">prerouting</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> routes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> usersAPI <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/usersAPI'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> usersAPI<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Let's populate our database with a user:</p> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data '{&quot;username&quot;: &quot;firstUser&quot;, &quot;password&quot;: &quot;firstUserpwd&quot; }' \
  http://localhost:3000/api/users/new
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">remember</p> <p>Remember to restart the server: <code>npm start</code></p></div> <p>BUT we see a 403 error! We need a user to create a user but to have that user we must create a user first! We are in a loophole!</p> <p>To fix this, on the <code>usersAPI.js</code> file we will remove the middleware for creating users, replace:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/users/new'</span><span class="token punctuation">,</span> Middleware<span class="token punctuation">.</span>hasAccess<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</code></pre></div><p>with:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/users/new'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</code></pre></div><p>Now run again, and the user will be created! We have defeated the loophole.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Depending on your use case, you may want to add the Middleware back again.</p></div> <h2 id="getting-the-token"><a href="#getting-the-token" class="header-anchor">#</a> Getting the token</h2> <p>So we have our first user created! But how do we give him an access token so that he can use the database?</p> <p>We will create a login endpoint in <code>usersAPI.js</code>:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// DELETE</span>

router<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/api/users/:id'</span><span class="token punctuation">,</span> Middleware<span class="token punctuation">.</span>hasAccess<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  usersController<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// LOGIN</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  usersController<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre></div><p>On the <code>usersController</code> create the login function:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  Users<span class="token punctuation">.</span><span class="token function">getUserByCredentials</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> accessToken <span class="token operator">=</span> Access<span class="token punctuation">.</span><span class="token function">generateToken</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> httpResponse<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'Ok'</span><span class="token punctuation">,</span> <span class="token string">'accessToken'</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> code <span class="token operator">=</span> errorHandler<span class="token punctuation">.</span><span class="token function">getHTTPCode</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> errorHandler<span class="token punctuation">.</span><span class="token function">getHTTPMessage</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> httpResponse<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> error<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span><span class="token operator">:</span> newElement<span class="token punctuation">,</span>
  template<span class="token punctuation">,</span>
  show<span class="token punctuation">,</span>
  index<span class="token punctuation">,</span>
  edit<span class="token punctuation">,</span>
  create<span class="token punctuation">,</span>
  find<span class="token punctuation">,</span>
  findById<span class="token punctuation">,</span>
  count<span class="token punctuation">,</span>
  update<span class="token punctuation">,</span>
  <span class="token keyword">delete</span><span class="token operator">:</span> del<span class="token punctuation">,</span>
  login<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Note that we are using the <code>Access</code> to generate the token, for it to work must be required at the beginning of the file:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Table<span class="token punctuation">,</span> ErrorHandler<span class="token punctuation">,</span> Access <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chinchay'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>So if we restart the server, run again <code>npm start</code> and run the following:</p> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data '{&quot;username&quot;: &quot;firstUser&quot;, &quot;password&quot;: &quot;firstUserpwd&quot; }' \
  http://localhost:3000/api/login
</code></pre></div><p>We receive our token!</p> <h3 id="token-encryption"><a href="#token-encryption" class="header-anchor">#</a> Token Encryption</h3> <div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>This is <strong>VERY IMPORTANT</strong>: The token is a jsonwebtoken encrypted by the <a href="https://en.wikipedia.org/wiki/Environment_variable" target="_blank" rel="noopener noreferrer">environment variable<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <code>JWT_SECRET</code>. You must define your own <code>JWT_SECRET</code> that must be kept confidential. If this variable is not defined, Chinchay will use a default secret, this will make your app prone to cyber-attacks.</p></div> <h3 id="returning-a-401-code"><a href="#returning-a-401-code" class="header-anchor">#</a> #Returning a 401 Code</h3> <p>So as you may have noticed, if we request the login endpoint with wrong credentials we get a 500 http code. Try it out:</p> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data '{&quot;username&quot;: &quot;firstUser&quot;, &quot;password&quot;: &quot;wrong password&quot; }' \
  http://localhost:3000/api/login
</code></pre></div><p>In case you don't know, the error 500 is a &quot;server-side&quot; error. Meaning something has gone wrong in the server. It is usually the http way of saying &quot;we do not know what the heck happened&quot;. Not truly the case though right? The problem is that the client (us) provided the wrong username/password combination. So how can we configure it so that this request responds with a more suitable code, such as 401 Unauthorized?</p> <h4 id="errorhandler"><a href="#errorhandler" class="header-anchor">#</a> ErrorHandler</h4> <p>Enter the.... ErrorHandler! The ErrorHandler is the one responsible for deciding the code to respond and an auxiliary message. It works hand by hand with the ChinchayError to map each error to a given code and message.</p> <p>So if we look at the users model we can see the following:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token keyword">async</span> <span class="token function">getUserByCredentials</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkCredentials</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ChinchayError</span><span class="token punctuation">(</span><span class="token string">'username password do not match'</span><span class="token punctuation">,</span> <span class="token string">'wrong_credentials'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>We see that we threw here a Chinchay Error. The second parameter is the identifier we want to provide to this error. In this case 'wrong_credentials'. So we need to tell the Error Handler that when it receives an Error with this identifier it should return a 401 code.</p> <p>So we will add the following to the controller:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">const</span> Users <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">ERROR_TRANSLATE</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  wrong_credentials<span class="token operator">:</span> <span class="token punctuation">{</span> code<span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span> message<span class="token operator">:</span> <span class="token string">'The combination username/password provided do not exist'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> errorHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorHandler</span><span class="token punctuation">(</span><span class="token constant">ERROR_TRANSLATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> viewPath <span class="token operator">=</span> <span class="token string">'../views/users'</span><span class="token punctuation">;</span>
</code></pre></div><p>Here we are indicating that the error 'wrong_credentials' should be mapped to the code 401. Go ahead and try it out!</p> <h2 id="configuring-thewall"><a href="#configuring-thewall" class="header-anchor">#</a> Configuring TheWall</h2> <p>So now we have our token! So far so good. Next step is to configure TheWall. Defining which user can access which data.</p> <h3 id="roles"><a href="#roles" class="header-anchor">#</a> roles</h3> <p>With TheWall you will assign roles to each user. One user can have many roles. Each role will give him access to certain data. On this tutorial we will have the following roles:</p> <ul><li>admin: This will have access to everything. is kind of a superuser.</li> <li>coffeeAdmin: Access to everything coffee related, can create, read, edit and delete coffees.</li> <li>teaAdmin: Access to everything tea related, can create, read, edit and delete teas.</li> <li>teaDrinker: Access to a specific tea (the one it's drinking). It can only read it. It cannot add, edit or delete teas.</li> <li>coffeeDrinker: Access to a specific coffee (the one it's drinking). It can only read it. It cannot add, edit nor coffee teas.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>I always recommend creating an admin role that has access to everything.</p></div> <h3 id="thewallfile"><a href="#thewallfile" class="header-anchor">#</a> thewallfile</h3> <p>Let's replace the configuration of the <code>thewallfile</code>:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  access<span class="token operator">:</span> <span class="token punctuation">{</span>
    admin<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// access everything</span>
    coffeeAdmin<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/api/coffee/*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// access to all routes starting with /api/coffee/</span>
    coffeeDrinker<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'/api/coffee/find'</span><span class="token punctuation">,</span> <span class="token comment">/* index with all the coffee it has access to */</span>
      <span class="token punctuation">[</span><span class="token string">'/api/coffee/:id'</span><span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">/* view the coffee with id=:id, only if it has the role coffeeDrinker to that :id. */</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> 
    teaAdmin<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/api/tea/*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">/* access to all routes starting with /api/tea/ */</span>
    teaDrinker<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'/api/tea/find'</span><span class="token punctuation">,</span> <span class="token comment">/* index with all the tea it has access to */</span>
      <span class="token punctuation">[</span><span class="token string">'/api/tea/:id'</span><span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">/* view the tea with id=:id, only if it has the role teaDrinker to that :id. */</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  knex<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'knex.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>For more information on how to configure TheWall check <a href="https://www.npmjs.com/package/thewall" target="_blank" rel="noopener noreferrer">TheWall documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h3 id="add-admin-role"><a href="#add-admin-role" class="header-anchor">#</a> add admin role</h3> <p>We will add an endpoint to add roles to users. On the <code>usersAPI.js</code> we add the endpoint:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// LOGIN</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  usersController<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ACCESS</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/users/:id/add/access'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  usersController<span class="token punctuation">.</span><span class="token function">addAccess</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre></div><p>Next in the <code>usersController</code> we add:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">addAccess</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> role<span class="token punctuation">,</span> filter <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  TheWall<span class="token punctuation">.</span><span class="token function">addAccess</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> role<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">access</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> httpResponse<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'Ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> code <span class="token operator">=</span> errorHandler<span class="token punctuation">.</span><span class="token function">getHTTPCode</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> errorHandler<span class="token punctuation">.</span><span class="token function">getHTTPMessage</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> httpResponse<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> error<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span><span class="token operator">:</span> newElement<span class="token punctuation">,</span>
  template<span class="token punctuation">,</span>
  show<span class="token punctuation">,</span>
  index<span class="token punctuation">,</span>
  edit<span class="token punctuation">,</span>
  create<span class="token punctuation">,</span>
  find<span class="token punctuation">,</span>
  findById<span class="token punctuation">,</span>
  count<span class="token punctuation">,</span>
  update<span class="token punctuation">,</span>
  <span class="token keyword">delete</span><span class="token operator">:</span> del<span class="token punctuation">,</span>
  login<span class="token punctuation">,</span>
  addAccess<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Note we need to import TheWall. This is the file we created <a href="#thewall-js">in this step</a>. Add the following line at the beginning of the <code>usersController</code>:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> TheWall <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../thewall'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we run the following:</p> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data '{&quot;role&quot;: &quot;admin&quot; }' \
  http://localhost:3000/api/users/1/add/access
</code></pre></div><p>Now our user with id 1 is an admin! Lastly let's add the Middleware to the route we created:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/users/:id/add/access'</span><span class="token punctuation">,</span> Middleware<span class="token punctuation">.</span>hasAccess<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  usersController<span class="token punctuation">.</span><span class="token function">addAccess</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ITS TIME! Let's test our API(and not get a forbidden error)!</p> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: Bearer ACCESS_TOKEN&quot; \
  --request POST \
  --data '{&quot;name&quot;: &quot;latte&quot;, &quot;price&quot;: &quot;100&quot; }' \
  http://localhost:3000/api/coffee/new
</code></pre></div><p>Note we added an Authorization Header, Replace <code>ACCESS_TOKEN</code> with the token received <a href="#getting-the-token">earlier</a>.</p> <h3 id="populate-ddbb"><a href="#populate-ddbb" class="header-anchor">#</a> populate ddbb</h3> <p>So we are going to use our user to create 1 more coffee and 2 teas:</p> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: Bearer ACCESS_TOKEN&quot; \
  --request POST \
  --data '{&quot;name&quot;: &quot;cappuccino&quot;, &quot;price&quot;: &quot;100&quot; }' \
  http://localhost:3000/api/coffee/new
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: Bearer ACCESS_TOKEN&quot; \
  --request POST \
  --data '{&quot;name&quot;: &quot;black tea&quot;, &quot;price&quot;: &quot;10&quot; }' \
  http://localhost:3000/api/tea/new
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: Bearer ACCESS_TOKEN&quot; \
  --request POST \
  --data '{&quot;name&quot;: &quot;green tea&quot;, &quot;price&quot;: &quot;20&quot; }' \
  http://localhost:3000/api/tea/new
</code></pre></div><h3 id="create-more-users"><a href="#create-more-users" class="header-anchor">#</a> create more users</h3> <p>Here we are going to create users. Note that only the admin can add access to each user, so for the add/access use the access token of the admin!</p> <h4 id="coffeeadmin"><a href="#coffeeadmin" class="header-anchor">#</a> coffeeAdmin</h4> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data '{&quot;username&quot;: &quot;User2&quot;, &quot;password&quot;: &quot;second&quot; }' \
  http://localhost:3000/api/users/new
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: Bearer ACCESS_TOKEN&quot; \
  --request POST \
  --data '{&quot;role&quot;: &quot;coffeeAdmin&quot; }' \
  http://localhost:3000/api/users/2/add/access
</code></pre></div><h4 id="teaadmin"><a href="#teaadmin" class="header-anchor">#</a> teaAdmin</h4> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data '{&quot;username&quot;: &quot;User3&quot;, &quot;password&quot;: &quot;password&quot; }' \
  http://localhost:3000/api/users/new
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: Bearer ACCESS_TOKEN&quot; \
  --request POST \
  --data '{&quot;role&quot;: &quot;teaAdmin&quot; }' \
  http://localhost:3000/api/users/3/add/access
</code></pre></div><h4 id="coffeedrinker"><a href="#coffeedrinker" class="header-anchor">#</a> coffeeDrinker</h4> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data '{&quot;username&quot;: &quot;User4&quot;, &quot;password&quot;: &quot;password&quot; }' \
  http://localhost:3000/api/users/new
</code></pre></div><p>This user will be drinking a latte, this is the coffee with id 1, so we define the filter as 1:</p> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: Bearer ACCESS_TOKEN&quot; \
  --request POST \
  --data '{&quot;role&quot;: &quot;coffeeDrinker&quot;, &quot;filter&quot;: 1 }' \
  http://localhost:3000/api/users/4/add/access
</code></pre></div><h4 id="teadrinker"><a href="#teadrinker" class="header-anchor">#</a> teaDrinker</h4> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --request POST \
  --data '{&quot;username&quot;: &quot;User5&quot;, &quot;password&quot;: &quot;password&quot; }' \
  http://localhost:3000/api/users/new
</code></pre></div><p>This user will be drinking a green tea, this is the tea with id 2, so we define the filter as 2:</p> <div class="language- extra-class"><pre class="language-text"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: Bearer ACCESS_TOKEN&quot; \
  --request POST \
  --data '{&quot;role&quot;: &quot;teaDrinker&quot;, &quot;filter&quot;: 2 }' \
  http://localhost:3000/api/users/5/add/access
</code></pre></div><h3 id="play-time"><a href="#play-time" class="header-anchor">#</a> play time</h3> <p>So... it's play time! You can now see what user can do what. Remember to first ask the access token for each user.</p> <ul><li>What users can create a new coffee?</li> <li>What users can create a new tea?</li> <li>What users can access the data of the coffee latte? What about cappuccino?</li> <li>What users can access the data of black tea? What about green tea?</li> <li>What users can access the data of a certain user?</li></ul> <h2 id="configuring-access"><a href="#configuring-access" class="header-anchor">#</a> Configuring Access</h2> <p>In your play time, did you try out: <code>http://localhost:300/api/coffee/find</code>. Does it work correctly?</p> <p>If you try to access that endpoint with a coffeeDrinker, all the coffees will be returned, where it should only return the coffees that he has access ro. TheWall filter on a per-endpoint basis, however in this case is the same endpoint, so TheWall is insufficient: Enter Chinchay's Access Module.</p> <h3 id="roles-2"><a href="#roles-2" class="header-anchor">#</a> roles</h3> <p>This module also works with roles. It has to type of roles:</p> <ul><li>RESTRICTED ROLES: roles that have access to a particular entry. Its accessibility is limited. For instance a coffeeDrinker only has access to certain coffees.</li> <li>UNRESTRICTED_ROLES: roles that have complete access on a particular module or subdivision of the app. Usually used for a certain database relation. For instance a coffeeAdmin has unrestricted access to the coffees.</li></ul> <h3 id="configuring-access-js"><a href="#configuring-access-js" class="header-anchor">#</a> Configuring access.js</h3> <p>Let's replace the configuration of the <code>access.js</code> created <a href="#access-js">in this step</a>:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">const</span> <span class="token constant">UNRESTRICTED_ROLES</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  coffee<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'coffeeAdmin'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  tea<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'teaAdmin'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">RESTRICTED_ROLES</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  coffee<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'coffeeDrinker'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  tea<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'teaDrinker'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">UNRESTRICTED_ROLES</span><span class="token punctuation">,</span>
  <span class="token constant">RESTRICTED_ROLES</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Now, we will replace the find function of the <code>coffeeController</code> for this one:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">find</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> userAccess <span class="token operator">=</span> req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>access <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> Table<span class="token punctuation">.</span><span class="token function">extractOptions</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> columns <span class="token operator">=</span> Table<span class="token punctuation">.</span><span class="token function">extractColumns</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> search <span class="token operator">=</span> Table<span class="token punctuation">.</span><span class="token function">extractSearch</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  search <span class="token operator">=</span> Access<span class="token punctuation">.</span><span class="token function">addAccessibleToSearch</span><span class="token punctuation">(</span>search<span class="token punctuation">,</span> userAccess<span class="token punctuation">,</span> <span class="token string">'coffee'</span><span class="token punctuation">,</span> <span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Coffee<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>search<span class="token punctuation">,</span> columns<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> httpResponse<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'Busqueda encontrada exitosamente'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> json<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      json<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>links <span class="token operator">=</span> <span class="token constant">HATEOAS</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> code <span class="token operator">=</span> errorHandler<span class="token punctuation">.</span><span class="token function">getHTTPCode</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> errorHandler<span class="token punctuation">.</span><span class="token function">getHTTPMessage</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> httpResponse<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> error<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Note that here we are adding to the search this access so it will filter which data should be returned. For it to work Access must be required at the beginning of the file:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Table<span class="token punctuation">,</span> ErrorHandler<span class="token punctuation">,</span> Access <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chinchay'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>So that's it! We have a functional API with different roles. We learned how to work with oAuth in Chinchay, how to configure TheWall and the Chinchay Access Module. A repository with the complete code of this tutorial can be found <a href="https://github.com/afontainec/tutorial-chinchay-api" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>For further reading go to the <a href="../docs">Chinchay Documentation</a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/gettingstarted/angular.html" class="prev">
        Getting Started: Chinchay + Angular
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2773cf3e.js" defer></script><script src="/assets/js/2.3f720234.js" defer></script><script src="/assets/js/22.ca5d3982.js" defer></script>
  </body>
</html>
